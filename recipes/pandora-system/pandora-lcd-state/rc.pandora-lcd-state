#!/bin/sh

### BEGIN INIT INFO
# Provides:          pandora-lcd-state
# Required-Start:    #adjust
# Required-Stop:     #adjust
# Default-Start:     S
# Default-Stop:      0 1 6
### END INIT INFO
 
DESC="OpenPandora Save and Restore LCD Settings"
NAME="pandora-lcd-state"

d_stop() {
	echo "Saving LCD and Nub-Settings"
	cat /sys/devices/platform/twl4030-pwm0-bl/backlight/twl4030-pwm0-bl/brightness > /etc/pandora/conf/brightness.state
	cat /sys/devices/platform/omap2_mcspi.1/spi1.1/gamma > /etc/pandora/conf/gamma.state
        cat cat -v /proc/pandora/vsense66 | sed -n '1p' > /etc/pandora/conf/nubs.state
	cat cat -v /proc/pandora/vsense67 | sed -n '1p' >> /etc/pandora/conf/nubs.state
}

d_start() {
	echo "Restoring LCD and Nub-Settings"
	cat /etc/pandora/conf/brightness.state > /sys/devices/platform/twl4030-pwm0-bl/backlight/twl4030-pwm0-bl/brightness 
	cat /etc/pandora/conf/gamma.state > /sys/devices/platform/omap2_mcspi.1/spi1.1/gamma
	sed -n '1p' /etc/pandora/conf/nubs.state > /proc/pandora/vsense66
	sed -n '2p' /etc/pandora/conf/nubs.state > /proc/pandora/vsense67
}

case "$1" in
  start)
	echo -n "Starting $DESC: $NAME - "
	d_start
	echo "."
	;;
  stop)
	echo -n "Stopping $DESC: $NAME - "
	d_stop
	echo "."
	;;
  reload)
	echo -n "Reloading $DESC: $NAME - "
	d_start
	echo "."
	;;	
  restart|force-reload)
	echo -n "Restarting $DESC: $NAME - "
	d_stop
	sleep 1
	d_start
	echo "."
	;;
  *)
	echo "Usage: $0 {start|stop|restart|reload|force-reload}" >&2
	exit 1
	;;
esac

exit 0
